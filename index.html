<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Commune – Autocomplétion (style Tally)</title>
  <style>
    html, body { background: transparent; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color: #111; }

    /* Largeur contrôlée */
    .wrap { width: 100%; max-width: 100%; margin: 0 auto; padding: 0; }

    /* Champ */
    .input { position: relative; }
    .input input {
      width: 100%;
      font-size: 16px;
      line-height: 1.2;
      padding: 10px 36px 10px 12px; /* hauteur + espace pour flèche */
      border: 1px solid #dcdcdc;
      border-radius: 10px;
      outline: none;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(61,130,246,0);
      transition: box-shadow .15s ease, border-color .15s ease;
      box-sizing: border-box;
      height: 46px; /* desktop parity */
    }
    .input input:focus { border-color: #8bb0ff; box-shadow: 0 0 0 3px rgba(61,130,246,.25); }
    .input input::placeholder {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      font-size: 16px;
      font-weight: 400;
      color: #BBBAB8; /* gris placeholder validé */
      opacity: 1;
    }
    /* petite flèche à droite */
    .input::after {
      content: ""; position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
      width: 14px; height: 14px; pointer-events: none;
      background: no-repeat center / 14px 14px url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 20 20' fill='none'%3E%3Cpath d='M5 7l5 5 5-5' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    }

    /* Dropdown */
    .listbox {
      position: absolute; left: 0; right: 0; top: calc(100% + 6px);
      border: 1px solid #e5e7eb; border-radius: 12px; background: #fff;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      max-height: 280px; overflow-y: auto; padding: 6px; z-index: 1000;
      -webkit-overflow-scrolling: touch; scroll-behavior: smooth;
    }
    .hidden { display: none; }
    .option { display: block; width: 100%; text-align: left; padding: 10px 10px; border-radius: 8px; cursor: pointer; border: 0; background: transparent; font: inherit; }
    .option:hover, .option:focus { background: #f6f6f6; }
    .option.active { background: #eef2ff; }

    .note { margin-top: 6px; font-size: 12px; color: #667085; min-height: 1em; display:none; }

    /* Mobile */
    @media (max-width: 480px) {
      .listbox { position: static; max-height: none; box-shadow: none; margin-top: 8px; }
      .option { padding: 10px 12px; font-size: 16px; }
      .input input { height: auto; }
    }

    /* Desktop */
    @media (min-width: 481px) {
      .wrap { max-width: 420px; padding: 0; }
      .listbox { position: absolute; left: 0; right: 0; top: calc(100% + 6px); max-height: 280px; box-shadow: 0 10px 30px rgba(0,0,0,.08); margin-top: 0; }
      .option { font-size: 16px; padding: 12px 14px; }
    }
  </style>
</head>
<body>
  <div class="wrap" role="combobox" aria-haspopup="listbox" aria-owns="list" aria-expanded="false">
    <div class="input">
      <input id="q" type="text" placeholder="Commencez à taper …" autocomplete="off" aria-autocomplete="list" aria-controls="list" aria-activedescendant="" aria-label="Commune" />
      <div id="list" class="listbox hidden" role="listbox" aria-label="Suggestions"></div>
    </div>
    <div id="note" class="note"></div>
  </div>

  <script>
    // ─────────────────────────────────────────────────────────────
    // PATCH — redirection Tally + slugs exacts des champs Short answer
    // ─────────────────────────────────────────────────────────────
    const REDIRECT_AFTER_PICK = true; // ← activer la redirection
    const TALLY_FORM_URL = 'https://tally.so/r/3xkYVv';

    // ⚠️ REMPLACE ces slugs par ceux de TES champs (via https://tally.so/api/v1/forms/3xkYVv → fields[].key)
    const KEYS = {
      commune:     'commune',       // ex. 'input_qYkWgq'
      code_postal: 'code_postal',   // ex. 'input_P4jM2n'
      insee:       'insee',         // ex. 'input_rK9xQz'
      label:       null             // optionnel: slug d'un champ visible "CP - Ville" (ex. 'input_AbCdEf')
    };

    // ─────────────────────────────────────────────────────────────
    const input = document.getElementById('q');
    const list  = document.getElementById('list');
    const note  = document.getElementById('note');
    const combo = document.querySelector('.wrap');

    let lastController = null;
    let items = [];
    let activeIndex = -1;

    function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), ms); }; }

    function formatLabel(f){
      const name = f.properties.name;
      const cp = (f.properties.postcode || '').split(';')[0] || '';
      const code = f.properties.citycode || f.properties.id || '';
      const cpPad = (cp || '').toString().padStart(5,'0');
      return { label: `${cpPad} - ${name}`, insee: code, postcode: cpPad, name };
    }

    async function search(q){
      if(!q || q.trim().length < 2){ hideList(); return; }
      if(lastController) lastController.abort();
      lastController = new AbortController();
      const url = new URL('https://api-adresse.data.gouv.fr/search/');
      url.searchParams.set('q', q.trim());
      url.searchParams.set('type','municipality');
      url.searchParams.set('limit','20');
      try{
        const res = await fetch(url, {signal: lastController.signal});
        const data = await res.json();
        items = (data.features||[]).map(formatLabel);
        renderList(items);
      }catch(err){ if(err.name !== 'AbortError'){ console.error(err); } }
    }

    function renderList(arr){
      if(!arr.length){ list.innerHTML = '<div class="option" role="option" aria-disabled="true">Aucun résultat</div>'; showList(); return; }
      activeIndex = -1;
      list.innerHTML = arr.map((it, idx)=>`<button class="option" role="option" id="opt-${idx}" data-idx="${idx}">${it.label}</button>`).join('');
      showList();
    }

    function showList(){ list.classList.remove('hidden'); combo.setAttribute('aria-expanded','true'); }
    function hideList(){ list.classList.add('hidden'); combo.setAttribute('aria-expanded','false'); }

    function setActive(i){
      const options = list.querySelectorAll('.option');
      options.forEach(o=>o.classList.remove('active'));
      if(i>=0 && i<options.length){
        activeIndex = i;
        const el = options[i];
        el.classList.add('active');
        el.focus({preventScroll:true});
        const boxTop = list.scrollTop; const boxBottom = boxTop + list.clientHeight;
        const elTop = el.offsetTop; const elBottom = elTop + el.offsetHeight;
        if(elTop < boxTop) list.scrollTop = elTop; else if(elBottom > boxBottom) list.scrollTop = elBottom - list.clientHeight;
        input.setAttribute('aria-activedescendant', el.id);
      }
    }

    function pick(i){
      const sel = items[i]; if(!sel) return;
      const value = `${sel.postcode} - ${sel.name}`;
      input.value = value;
      try { navigator.clipboard.writeText(value); } catch(_) {}
      try { parent.postMessage({type:'COMMUNE_SELECTED', payload: sel}, '*'); } catch(_) {}
      hideList();

      if (REDIRECT_AFTER_PICK) {
        const params = new URLSearchParams({
          [KEYS.commune]:     sel.name,
          [KEYS.code_postal]: sel.postcode,
          [KEYS.insee]:       sel.insee
        });
        if (KEYS.label) params.set(KEYS.label, value);
        const url = `${TALLY_FORM_URL}?${params.toString()}`;
        setTimeout(()=>{ try { window.top.location.href = url; } catch(_) { window.open(url,'_blank'); } }, 120);
      }
    }

    // Événements
    input.addEventListener('input', debounce(()=>search(input.value), 140));
    input.addEventListener('keydown', (e)=>{
      const open = !list.classList.contains('hidden');
      if(e.key==='ArrowDown') { e.preventDefault(); if(!open) renderList(items); setActive(Math.min(activeIndex+1, items.length-1)); }
      else if(e.key==='ArrowUp') { e.preventDefault(); setActive(Math.max(activeIndex-1, 0)); }
      else if(e.key==='Enter') { if(open && activeIndex>=0) { e.preventDefault(); pick(activeIndex); } }
      else if(e.key==='Escape') { hideList(); }
    });

    list.addEventListener('click', (e)=>{ const btn = e.target.closest('.option'); if(!btn) return; pick(+btn.dataset.idx); });
    document.addEventListener('click', (e)=>{ if(!document.querySelector('.wrap').contains(e.target)) hideList(); });
    input.addEventListener('blur', ()=> setTimeout(()=>{ if(!document.activeElement || !list.contains(document.activeElement)) hideList(); }, 150));
  </script>
</body>
</html>
