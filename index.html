<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Commune – Autocomplétion minimale</title>
  <style>
    /* Style ultra-épuré pour s'intégrer dans Tally */
    html, body { background: transparent; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color: #111; }

    /* Largeur réduite du champ */
    .wrap { max-width: 420px; margin: 0; }

    .input { position: relative; }
    .input input { 
      width: 100%;
      font-size: 16px;
      line-height: 1.3;
      padding: 12px 14px;
      border: 1px solid #dcdcdc;
      border-radius: 12px;
      outline: none;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(61,130,246,0);
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    .input input:focus {
      border-color: #8bb0ff;
      box-shadow: 0 0 0 3px rgba(61,130,246,.25);
    }
    .input input::placeholder { color: #9aa1a9; }

    .list { 
      position: relative; 
      margin-top: 8px; 
      border: 1px solid #eee; 
      border-radius: 12px; 
      overflow: hidden; 
      background: #fff; 
      max-height: 280px; 
      overflow-y: auto; 
    }
    .hidden { display: none; }
    .item { padding: 10px 12px; cursor: pointer; }
    .item:hover, .item:focus { background: #f6f6f6; }
    .name { font-weight: 600; }

    .note { margin-top: 6px; font-size: 12px; color: #667085; }
    .ok { color: #0a7a1c; font-weight: 600; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="input">
      <input id="q" type="text" placeholder="Commencez à taper …" autocomplete="off" aria-label="Commune" />
      <div id="list" class="list hidden" role="listbox" aria-label="Suggestions"></div>
    </div>
    <div id="note" class="note"></div>
  </div>

  <script>
    // URL de ton formulaire Tally pour préremplissage (intégrée comme demandé)
    const TALLY_FORM_URL = 'https://tally.so/r/3xkYVv';

    const input = document.getElementById('q');
    const list = document.getElementById('list');
    const note = document.getElementById('note');

    let lastController = null;
    let items = [];

    function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), ms); }; }

    function formatLabel(f){
      const name = f.properties.name;
      const cp = (f.properties.postcode || '').split(';')[0] || '';
      const code = f.properties.citycode || f.properties.id || '';
      const cpPad = (cp || '').toString().padStart(5,'0');
      return {
        // Affichage demandé : CP - Commune (ex : 17000 - La Rochelle)
        label: `${cpPad} - ${name}`,
        insee: code,
        postcode: cpPad,
        name
      };
    }

    async function search(q){
      if(!q || q.trim().length < 2){ list.innerHTML=''; list.classList.add('hidden'); return; }
      if(lastController) lastController.abort();
      lastController = new AbortController();
      const url = new URL('https://api-adresse.data.gouv.fr/search/');
      url.searchParams.set('q', q.trim());
      url.searchParams.set('type','municipality');
      url.searchParams.set('limit','12');
      try{
        const res = await fetch(url, {signal: lastController.signal});
        const data = await res.json();
        items = (data.features||[]).map(formatLabel);
        if(!items.length){ list.innerHTML = '<div class="item">Aucun résultat</div>'; list.classList.remove('hidden'); return; }
        list.innerHTML = items.map((it,idx)=>`
          <div class="item" data-idx="${idx}" role="option" tabindex="0">
            <div class="name">${it.label}</div>
          </div>
        `).join('');
        list.classList.remove('hidden');
      }catch(err){ if(err.name !== 'AbortError'){ console.error(err); } }
    }

    input.addEventListener('input', debounce(()=>search(input.value), 160));

    list.addEventListener('click', onPick);
    list.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const el = e.target.closest('.item'); if(el) onPick({target:el}); }});

    async function onPick(e){
      const el = e.target.closest('.item');
      if(!el) return;
      const idx = +el.dataset.idx;
      const selected = items[idx];
      if(!selected) return;

      const txt = `${selected.postcode} - ${selected.name}`;

      // 1) Copier dans le presse-papiers
      try { await navigator.clipboard.writeText(txt); } catch(_) {}

      // 2) Informer la page parente (Tally) si un écouteur existe
      try { parent.postMessage({type:'COMMUNE_SELECTED', payload: selected}, '*'); } catch(_) {}

      // 3) Note discrète
      note.innerHTML = `<span class="ok">Sélection enregistrée</span> — ${txt}`;

      // 4) Rediriger vers le formulaire Tally prérempli
      const params = new URLSearchParams({
        commune: selected.name,
        code_postal: selected.postcode,
        insee: selected.insee,
        commune_label: selected.label
      });
      const url = `${TALLY_FORM_URL}?${params.toString()}`;
      setTimeout(()=>{
        try { window.top.location.href = url; } catch(_) { window.open(url, '_blank'); }
      }, 200);

      list.classList.add('hidden');
    }
  </script>
</body>
</html>
