<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Commune – Autocomplétion (style Tally)</title>
  <style>
    html, body { background: transparent; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color: #111; }

    .wrap { width: 100%; max-width: 100%; margin: 0 auto; padding: 0; }

    .input { position: relative; }
    .input input {
      width: 100%;
      font-size: 16px;
      line-height: 1.2;
      padding: 10px 36px 10px 12px;
      border: 1px solid #dcdcdc;
      border-radius: 10px;
      outline: none;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(61,130,246,0);
      transition: box-shadow .15s ease, border-color .15s ease;
      box-sizing: border-box;
    }
    .input input:focus { border-color: #8bb0ff; box-shadow: 0 0 0 3px rgba(61,130,246,.25); }
    .input input::placeholder {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      font-size: 16px;
      font-weight: 400;
      color: #BBBAB8;
      opacity: 1;
    }

    .listbox {
      position: absolute; left: 0; right: 0; top: calc(100% + 6px);
      border: 1px solid #e5e7eb; border-radius: 12px; background: #fff;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      max-height: 280px; overflow-y: auto; padding: 6px;
      z-index: 1000; -webkit-overflow-scrolling: touch; scroll-behavior: smooth;
    }
    .hidden { display: none; }
    .option { display: block; width: 100%; text-align: left; padding: 10px 10px; border-radius: 8px; cursor: pointer; border: 0; background: transparent; font: inherit; }
    .option:hover, .option:focus { background: #f6f6f6; }
    .option.active { background: #eef2ff; }

    .note { margin-top: 6px; font-size: 12px; color: #667085; min-height: 1em; }

    @media (max-width: 480px) {
      .listbox { position: static; max-height: none; box-shadow: none; margin-top: 8px; }
      .option { padding: 10px 12px; font-size: 16px; }
    }

    @media (min-width: 481px) {
      .wrap { max-width: 420px; padding: 0; }
      .option { font-size: 16px; padding: 12px 14px; }
    }

    /* bouton */
    #go {
      display:none; margin-top:10px; padding:8px 14px; font-size:15px;
      border-radius:8px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="wrap" role="combobox" aria-haspopup="listbox" aria-owns="list" aria-expanded="false">
    <div class="input">
      <input id="q" type="text" placeholder="Commencez à taper …" autocomplete="off" aria-autocomplete="list" aria-controls="list" aria-activedescendant="" />
      <div id="list" class="listbox hidden" role="listbox" aria-label="Suggestions"></div>
    </div>

    <!-- bouton validé au clic (geste utilisateur) -->
    <a id="go" href="#" target="_top" role="button"
       style="display:none;margin-top:10px;padding:8px 14px;font-size:15px;border-radius:8px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer;text-decoration:none;display:inline-block;">
      Ouvrir le formulaire prérempli
    </a>

    <div id="note" class="note"></div>
  </div>

  <script>
    const TALLY_FORM_URL = 'https://tally.so/r/3xkYVv';

    const input = document.getElementById('q');
    const list  = document.getElementById('list');
    const combo = document.querySelector('.wrap');
    const btnGo = document.getElementById('go');

    let lastController = null;
    let items = [];
    let activeIndex = -1;
    let lastSel = null; // mémorise la sélection

    function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), ms); }; }

    function formatLabel(f){
      const name = f.properties.name;
      const cp = (f.properties.postcode || '').split(';')[0] || '';
      const code = f.properties.citycode || f.properties.id || '';
      const cpPad = (cp || '').toString().padStart(5,'0');
      return { label: `${cpPad} - ${name}`, insee: code, postcode: cpPad, name };
    }

    // évite les 400: n’appelle l’API qu’à partir de 3 caractères, et gère les codes postaux
    function buildAdresseUrl(raw){
      const q = (raw || '').trim();
      if (!q) return null;

      const url = new URL('https://api-adresse.data.gouv.fr/search/');
      url.searchParams.set('type','municipality');
      url.searchParams.set('limit','20');
      url.searchParams.set('autocomplete','1');

      if (/^\\d+$/.test(q)) {
        if (q.length < 3) return null;
        url.searchParams.set('postcode', q);
      } else {
        if (q.length < 3) return null;
        url.searchParams.set('q', q);
      }
      return url;
    }

    async function search(q){
      const url = buildAdresseUrl(q);
      if(!url){ hideList(); return; }

      if(lastController) lastController.abort();
      lastController = new AbortController();

      try{
        const res = await fetch(url, {signal: lastController.signal});
        if(!res.ok){ hideList(); return; }
        const data = await res.json();
        items = (data.features||[]).map(formatLabel);
        renderList(items);
      }catch(err){ if(err.name !== 'AbortError'){ console.error(err); } }
    }

    function renderList(arr){
      if(!arr.length){ list.innerHTML = '<div class="option" role="option" aria-disabled="true">Aucun résultat</div>'; showList(); return; }
      activeIndex = -1;
      list.innerHTML = arr.map((it, idx)=>`<button class="option" role="option" id="opt-${idx}" data-idx="${idx}">${it.label}</button>`).join('');
      showList();
    }

    function showList(){ list.classList.remove('hidden'); combo.setAttribute('aria-expanded','true'); }
    function hideList(){ list.classList.add('hidden'); combo.setAttribute('aria-expanded','false'); }

    function setActive(i){
      const options = list.querySelectorAll('.option');
      options.forEach(o=>o.classList.remove('active'));
      if(i>=0 && i<options.length){
        activeIndex = i;
        const el = options[i];
        el.classList.add('active');
        el.focus({preventScroll:true});
        const boxTop = list.scrollTop, boxBottom = boxTop + list.clientHeight;
        const elTop = el.offsetTop, elBottom = elTop + el.offsetHeight;
        if(elTop < boxTop) list.scrollTop = elTop;
        else if(elBottom > boxBottom) list.scrollTop = elBottom - list.clientHeight;
        input.setAttribute('aria-activedescendant', el.id);
      }
    }

    function pick(i){
      const sel = items[i];
      if (!sel) return;
    
      lastSel = sel;
      const value = `${sel.postcode} - ${sel.name}`;
      input.value = value;
      hideList();
    
      // Construire l'URL Tally préremplie
      const params = new URLSearchParams({
        commune: sel.name,
        code_postal_1: sel.postcode,
        insee: sel.insee
      });
      const url = `${TALLY_FORM_URL}?${params.toString()}`;
    
      // Armer le lien (clic utilisateur => navigation au top)
      btnGo.href = url;
      btnGo.style.display = 'inline-block';
      console.log('Lien prérempli prêt :', url);
    }


    // Événements
    input.addEventListener('input', debounce(()=>search(input.value), 140));
    input.addEventListener('keydown', (e)=>{
      const open = !list.classList.contains('hidden');
      if(e.key==='ArrowDown'){ e.preventDefault(); if(!open) renderList(items); setActive(Math.min(activeIndex+1, items.length-1)); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); setActive(Math.max(activeIndex-1, 0)); }
      else if(e.key==='Enter'){ if(open && activeIndex>=0){ e.preventDefault(); pick(activeIndex); } }
      else if(e.key==='Escape'){ hideList(); }
    });

    list.addEventListener('click', (e)=>{
      const btn = e.target.closest('.option'); if(!btn) return; pick(+btn.dataset.idx);
    });

    document.addEventListener('click', (e)=>{
      if(!document.querySelector('.wrap').contains(e.target)) hideList();
    });

    input.addEventListener('blur', ()=> setTimeout(()=>{ if(!document.activeElement || !list.contains(document.activeElement)) hideList(); }, 150));

  </script>
</body>
</html>
